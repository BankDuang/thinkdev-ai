<div class="modal-overlay" onclick="if(event.target===this) this.remove()">
    <div class="modal" style="width:520px">
        <div class="modal-header">
            <span>{% if mode == 'edit' %}Edit Project{% else %}New Project{% endif %}</span>
            <button class="btn-icon" onclick="this.closest('.modal-overlay').remove()">&#10005;</button>
        </div>

        {% if error %}
        <div class="form-error">{{ error }}</div>
        {% endif %}

        {% if mode != 'edit' %}
        <!-- Tabs: Empty / GitHub -->
        <div class="form-tabs">
            <button class="form-tab active" onclick="switchProjectTab('empty', this)">Empty Project</button>
            <button class="form-tab" onclick="switchProjectTab('github', this)">Clone from GitHub</button>
        </div>

        <!-- GitHub search section (hidden by default) -->
        <div id="github-search-section" style="display:none">
            <div class="form-group">
                <label>GitHub Username</label>
                <div style="display:flex;gap:6px">
                    <input type="text" id="github-username" placeholder="e.g. BankDuang"
                           onkeydown="if(event.key==='Enter'){event.preventDefault();fetchGitHubRepos();}">
                    <button type="button" class="btn btn-primary" onclick="fetchGitHubRepos()" style="flex-shrink:0">Search</button>
                </div>
            </div>
            <div class="form-group">
                <label>Personal Access Token <span style="color:var(--text-muted);font-weight:400">(optional, for private repos)</span></label>
                <input type="password" id="github-token" placeholder="ghp_xxxx..."
                       onkeydown="if(event.key==='Enter'){event.preventDefault();fetchGitHubRepos();}">
                <small class="form-hint">Generate at github.com/settings/tokens. Needed to see private repos.</small>
            </div>
            <div id="github-repo-list" class="github-repo-list"></div>
        </div>
        {% endif %}

        <form {% if mode == 'edit' %}
                hx-put="/projects/{{ project.id }}/update"
              {% else %}
                hx-post="/projects/create"
              {% endif %}
              hx-target="#project-list"
              hx-swap="innerHTML"
              hx-on::after-request="if(event.detail.successful) this.closest('.modal-overlay').remove()">

            <div id="manual-fields">
            <div class="form-group">
                <label for="name">Project Name</label>
                <input type="text" id="name" name="name" required
                       placeholder="my-project"
                       value="{{ project.name if project else '' }}">
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="2"
                          placeholder="Optional description">{{ project.description if project else '' }}</textarea>
            </div>

            <div class="form-group" id="git-url-group">
                <label for="git_repository_url">Git Repository URL</label>
                <input type="text" id="git_repository_url" name="git_repository_url"
                       placeholder="https://github.com/user/repo.git (optional)"
                       value="{{ project.git_repository_url if project else '' }}">
                <small class="form-hint">Leave empty to create an empty project, or provide a URL to clone.</small>
            </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary"
                        onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    {% if mode == 'edit' %}Save Changes{% else %}Create Project{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function switchProjectTab(tab, btn) {
    document.querySelectorAll('.form-tab').forEach(function(t) { t.classList.remove('active'); });
    btn.classList.add('active');
    var ghSection = document.getElementById('github-search-section');
    var manualFields = document.getElementById('manual-fields');
    if (ghSection) ghSection.style.display = tab === 'github' ? '' : 'none';
    if (manualFields) manualFields.style.display = tab === 'github' ? 'none' : '';
    // When switching to empty tab, clear required hack
    var nameInput = document.getElementById('name');
    if (nameInput) nameInput.required = (tab !== 'github');
}

function fetchGitHubRepos() {
    var username = document.getElementById('github-username').value.trim();
    if (!username) return;
    var token = document.getElementById('github-token') ? document.getElementById('github-token').value.trim() : '';
    var list = document.getElementById('github-repo-list');
    list.innerHTML = '<div class="empty-state" style="padding:12px">Loading repos...</div>';
    var url = '/projects/github/repos?username=' + encodeURIComponent(username);
    if (token) url += '&token=' + encodeURIComponent(token);
    fetch(url)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                list.innerHTML = '<div class="form-error">' + data.error + '</div>';
                return;
            }
            if (!data.repos.length) {
                list.innerHTML = '<div class="empty-state" style="padding:12px">No repos found</div>';
                return;
            }
            var html = '';
            data.repos.forEach(function(repo) {
                var cloneUrl = repo.clone_url;
                if (repo.private && token) {
                    cloneUrl = cloneUrl.replace('https://', 'https://' + token + '@');
                }
                html += '<div class="github-repo-item" onclick="selectGitHubRepo(this)" ' +
                    'data-name="' + repo.name + '" ' +
                    'data-url="' + cloneUrl + '" ' +
                    'data-desc="' + (repo.description || '').replace(/"/g, '&quot;') + '">' +
                    '<div class="github-repo-name">' + repo.name +
                    (repo.private ? ' <span class="github-repo-private">Private</span>' : '') +
                    (repo.language ? ' <span class="github-repo-lang">' + repo.language + '</span>' : '') +
                    '</div>' +
                    (repo.description ? '<div class="github-repo-desc">' + repo.description + '</div>' : '') +
                    '</div>';
            });
            list.innerHTML = html;
        })
        .catch(function(e) {
            list.innerHTML = '<div class="form-error">Failed to fetch repos</div>';
        });
}

function selectGitHubRepo(el) {
    document.querySelectorAll('.github-repo-item').forEach(function(r) { r.classList.remove('selected'); });
    el.classList.add('selected');
    document.getElementById('name').value = el.dataset.name;
    document.getElementById('git_repository_url').value = el.dataset.url;
    document.getElementById('description').value = el.dataset.desc || '';
}
</script>
